<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å››å¹´ç´šå¥åº·å¤§å†’éšª - å³å´QRç‰ˆ</title>
    <style>
        :root {
            --pk-red: #ff1c1c;
            --pk-white: #f0f0f0;
            --pk-black: #222;
            --pk-blue: #3b4cca;
            --pk-yellow: #ffde00;
        }

        body {
            font-family: "Microsoft JhengHei", "Heiti TC", sans-serif;
            background-color: #333;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: var(--pk-black);
            user-select: none;
        }

        #game-container {
            width: 800px;
            height: 600px;
            background-color: var(--pk-white);
            border: 8px solid var(--pk-black);
            border-radius: 10px;
            position: relative; /* è®“å…§éƒ¨çš„çµ•å°å®šä½ä»¥é€™è£¡ç‚ºåŸºæº– */
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        .header-bar {
            height: 60px;
            background-color: var(--pk-red);
            border-bottom: 4px solid var(--pk-black);
            display: flex;
            align-items: center;
            padding-left: 20px;
            color: white;
            font-size: 18px;
            font-weight: bold;
        }

        .screen {
            padding: 20px;
            height: calc(100% - 100px);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .active { display: flex !important; }

        h1 {
            font-size: 36px;
            color: var(--pk-blue);
            margin-bottom: 20px;
            text-shadow: 2px 2px var(--pk-yellow);
            font-weight: 900;
        }

        .btn {
            background-color: var(--pk-white);
            border: 4px solid var(--pk-black);
            padding: 15px 30px;
            margin: 8px;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 4px 4px 0px rgba(0,0,0,0.2);
            width: 300px;
            font-weight: bold;
        }

        .btn:hover {
            background-color: var(--pk-yellow);
            transform: translate(-2px, -2px);
        }

        .btn:active {
            transform: translate(2px, 2px);
            box-shadow: none;
        }

        /* --- QR Code å€åŸŸæ¨£å¼ (ä¿®æ”¹ç‚ºå³å´æ‡¸æµ®) --- */
        #qr-container {
            display: none; /* é è¨­éš±è— */
            position: absolute; /* çµ•å°å®šä½ */
            right: 40px;        /* é å³è·é›¢ */
            top: 55%;           /* å‚ç›´é«˜åº¦ */
            transform: translateY(-50%); /* å‚ç›´ç½®ä¸­æ ¡æ­£ */
            
            border: 4px solid var(--pk-black);
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 6px 6px 0px rgba(0,0,0,0.2);
            z-index: 50;
            animation: popIn 0.3s;
        }
        
        @keyframes popIn {
            from { opacity: 0; transform: translateY(-50%) scale(0.5); }
            to { opacity: 1; transform: translateY(-50%) scale(1); }
        }

        input[type="text"] {
            font-size: 20px;
            padding: 10px;
            border: 4px solid var(--pk-black);
            margin-bottom: 20px;
            width: 250px;
            text-align: center;
        }

        .question-box {
            border: 4px solid var(--pk-black);
            padding: 20px;
            background: white;
            width: 90%;
            margin-bottom: 20px;
            border-radius: 5px;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            line-height: 1.6;
            font-size: 20px;
            font-weight: bold;
        }

        .options-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            width: 95%;
        }

        .option-btn {
            width: 100%;
            margin: 0;
            text-align: left;
            font-size: 18px;
            padding: 12px;
        }

        .checkbox-group {
            text-align: left;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            width: 90%;
            margin-bottom: 20px;
        }
        .checkbox-item {
            font-size: 18px;
            display: flex;
            align-items: center;
            cursor: pointer;
        }
        .checkbox-item input {
            margin-right: 10px;
            width: 24px;
            height: 24px;
        }

        .feedback-modal {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            z-index: 100;
        }

        .feedback-content {
            background: var(--pk-white);
            color: var(--pk-black);
            border: 6px solid var(--pk-yellow);
            padding: 30px;
            width: 80%;
            text-align: left;
            border-radius: 10px;
            box-shadow: 0 0 20px #fff;
        }
        
        table {
            width: 90%;
            border-collapse: collapse;
            font-size: 16px;
            margin-top: 10px;
            background: white;
        }
        th, td {
            border: 2px solid var(--pk-black);
            padding: 8px;
            text-align: center;
        }
        th { background-color: var(--pk-red); color: white; }
    </style>
</head>
<body>

<div id="game-container">
    <div class="header-bar">
        <span>HP: <span id="hp-display">100/100</span> | LV: 4å¹´ç´š</span>
    </div>

    <div id="screen-home" class="screen active">
        <h1>å¥åº·çŸ¥è­˜<br>å¤§å¸«æŒ‘æˆ°è³½</h1>
        <div style="font-size:60px; margin-bottom:10px;">â›‘ï¸</div>
        
        <button class="btn" onclick="goToNameInput()">é–‹å§‹éŠæˆ²</button>
        <button class="btn" onclick="retryGame()">å†ä¾†ä¸€æ¬¡</button>
        <button class="btn" onclick="showLeaderboard()">ç©åˆ†æ’è¡Œ</button>
        <button class="btn" style="background-color: #e0f7fa;" onclick="toggleQRCode()">ğŸ“± é¡¯ç¤º QR Code</button>

        <div id="qr-container">
            <p style="font-size:16px; margin:5px 0; font-weight:bold;">æƒæåŠ å…¥å†’éšªï¼</p>
            <img id="qr-image" src="" alt="QR Code" width="160" height="160">
            <p style="font-size:12px; margin-top:5px; color:#666;">(è«‹ç¢ºèªå·²é€£ä¸Šç¶²è·¯)</p>
        </div>
    </div>

    <div id="screen-name" class="screen">
        <h2>è«‹è¼¸å…¥è¨“ç·´å®¶å§“å</h2>
        <input type="text" id="player-name" placeholder="ä½ çš„åå­—" maxlength="10">
        <button class="btn" onclick="startGame(false)">å‡ºç™¼ï¼</button>
        <button class="btn" onclick="goHome()">è¿”å›</button>
    </div>

    <div id="screen-game" class="screen">
        <div style="display:flex; justify-content:space-between; width:90%; font-size:16px; margin-bottom:10px; font-weight:bold;">
            <span id="q-progress">é¡Œç›®: 1/21</span>
            <span id="score-display">å¾—åˆ†: 0</span>
        </div>
        <div class="question-box">
            <div id="question-type" style="color:var(--pk-blue); margin-bottom:10px;"></div>
            <div id="question-text">é¡Œç›®è¼‰å…¥ä¸­...</div>
        </div>
        
        <div id="options-area" class="options-grid"></div>
        <div id="checkbox-area" class="checkbox-group" style="display:none;"></div>
        <button id="submit-check-btn" class="btn" style="display:none; margin: 0 auto;" onclick="checkCheckboxAnswer()">æ±ºå®šå°±æ˜¯ä½ äº†ï¼</button>
    </div>

    <div id="screen-result" class="screen">
        <h2>æŒ‘æˆ°çµæŸï¼</h2>
        <p>è¨“ç·´å®¶ï¼š<span id="result-name"></span></p>
        <p>æœ€çµ‚å¾—åˆ†ï¼š<span id="result-score" style="color:var(--pk-red); font-size: 36px; font-weight:bold;"></span></p>
        <p>è€—æ™‚ï¼š<span id="result-time"></span></p>
        <div style="margin-top:30px;">
            <button class="btn" onclick="showLeaderboard()">æŸ¥çœ‹ç©åˆ†æ’è¡Œ</button>
            <button class="btn" onclick="goHome()">å›åˆ°é¦–é </button>
        </div>
    </div>

    <div id="screen-leaderboard" class="screen">
        <h2>åäººå ‚ (ç©åˆ†æ’è¡Œ)</h2>
        <div style="height: 350px; overflow-y: auto; width: 100%;">
            <table id="leaderboard-table">
                <thead>
                    <tr><th>åæ¬¡</th><th>è¨“ç·´å®¶</th><th>åˆ†æ•¸</th><th>æ™‚é–“</th></tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <button class="btn" style="margin-top:20px;" onclick="goHome()">è¿”å›</button>
    </div>

    <div id="feedback-modal" class="feedback-modal">
        <div class="feedback-content">
            <h2 id="feedback-title"></h2>
            <div id="feedback-detail" style="font-size: 18px; line-height: 1.6; margin: 20px 0;"></div>
            <button class="btn" style="width: 100%;" onclick="nextQuestion()">ç¹¼çºŒå†’éšª</button>
        </div>
    </div>
</div>

<script>
// --- éŒ¯èª¤æ””æˆª ---
window.onerror = function(msg, url, line) {
   alert("ç¨‹å¼ç™¼ç”ŸéŒ¯èª¤ï¼š\n" + msg);
   return true;
};

// --- å…¨åŸŸè®Šæ•¸ ---
var gameState = {
    playerName: "è¨“ç·´å®¶",
    currentQuestions: [],
    currentIndex: 0,
    score: 0,
    startTime: 0,
    endTime: 0
};

// --- QR Code åŠŸèƒ½ ---
function toggleQRCode() {
    var qrContainer = document.getElementById('qr-container');
    var qrImage = document.getElementById('qr-image');
    
    // å¦‚æœç›®å‰æ˜¯éš±è—çš„ï¼Œå°±é¡¯ç¤ºä¸¦ç”¢ç”Ÿ
    if (qrContainer.style.display === 'none' || qrContainer.style.display === '') {
        var currentUrl = window.location.href;
        
        // æª¢æŸ¥æ˜¯å¦ç‚ºæœ¬æ©Ÿæª”æ¡ˆ
        if (currentUrl.startsWith("file://")) {
            alert("âš ï¸ è€å¸«è«‹æ³¨æ„ï¼š\næ‚¨ç›®å‰æ˜¯åœ¨é›»è…¦ç¡¬ç¢Ÿä¸­é–‹å•Ÿæ­¤æª”æ¡ˆã€‚\n\né€™å€‹ QR Code æƒæå¾Œï¼Œå­¸ç”Ÿçš„æ‰‹æ©Ÿå°‡ç„¡æ³•é€£ç·šï¼\n\nè«‹å‹™å¿…å°‡æ­¤ç¶²é ä¸Šå‚³åˆ°ç¶²ç«™ç©ºé–“ï¼ŒQR Code æ‰èƒ½æ­£å¸¸é‹ä½œå–”ï¼");
        }
        
        // ä½¿ç”¨å…è²» API ç”¢ç”Ÿ QR Code
        qrImage.src = "https://api.qrserver.com/v1/create-qr-code/?size=160x160&data=" + encodeURIComponent(currentUrl);
        qrContainer.style.display = 'block';
    } else {
        qrContainer.style.display = 'none';
    }
}

// --- ä»‹é¢åˆ‡æ› ---
function showScreen(screenId) {
    var screens = document.querySelectorAll('.screen');
    for(var i=0; i<screens.length; i++) {
        screens[i].classList.remove('active');
    }
    document.getElementById(screenId).classList.add('active');
    
    // åˆ‡æ›ç•«é¢æ™‚ï¼ŒæŠŠ QR Code è—èµ·ä¾†
    document.getElementById('qr-container').style.display = 'none';
}

function goToNameInput() { showScreen('screen-name'); }
function goHome() { showScreen('screen-home'); }

function retryGame() {
    if (gameState.playerName && gameState.playerName !== "è¨“ç·´å®¶") {
        startGame(true);
    } else {
        goToNameInput();
    }
}

// --- éŠæˆ²é‚è¼¯ ---
function startGame(skipInput) {
    if (!skipInput) {
        var nameInput = document.getElementById('player-name').value.trim();
        if (!nameInput) {
            alert("è«‹è¼¸å…¥è¨“ç·´å®¶å§“åï¼");
            return;
        }
        gameState.playerName = nameInput;
        try { localStorage.setItem('lastPlayer', nameInput); } catch(e){}
    }

    gameState.score = 0;
    gameState.currentIndex = 0;
    gameState.startTime = new Date();
    
    generateQuiz();
    showScreen('screen-game');
    renderQuestion();
}

function generateQuiz() {
    // éš¨æ©Ÿé¸ 10 é¡Œæ˜¯é
    var shuffledTF = poolTF.sort(function() { return 0.5 - Math.random(); }).slice(0, 10);
    // éš¨æ©Ÿé¸ 10 é¡Œé¸æ“‡
    var shuffledMC = poolMC.sort(function() { return 0.5 - Math.random(); }).slice(0, 10);
    
    // æ¨™è¨˜é¡å‹
    for(var i=0; i<shuffledTF.length; i++) shuffledTF[i].type = 'TF';
    for(var i=0; i<shuffledMC.length; i++) shuffledMC[i].type = 'MC';
    var qCheck = Object.assign({}, fixedCheckQ); 
    qCheck.type = 'CHECK';

    var allQ = shuffledTF.concat(shuffledMC);
    allQ.sort(function() { return 0.5 - Math.random(); });
    allQ.push(qCheck);
    
    gameState.currentQuestions = allQ;
}

function renderQuestion() {
    var q = gameState.currentQuestions[gameState.currentIndex];
    var total = gameState.currentQuestions.length;
    
    document.getElementById('q-progress').innerText = "é¡Œç›®: " + (gameState.currentIndex + 1) + "/" + total;
    document.getElementById('score-display').innerText = "å¾—åˆ†: " + gameState.score;
    
    var typeText = "";
    if (q.type === 'TF') typeText = "ã€æ˜¯éé¡Œã€‘";
    if (q.type === 'MC') typeText = "ã€é¸æ“‡é¡Œã€‘";
    if (q.type === 'CHECK') typeText = "ã€å¤šé‡å‹¾é¸é¡Œã€‘";
    
    document.getElementById('question-type').innerText = typeText;
    document.getElementById('question-text').innerText = q.q;

    var optionsArea = document.getElementById('options-area');
    var checkArea = document.getElementById('checkbox-area');
    var checkBtn = document.getElementById('submit-check-btn');

    optionsArea.innerHTML = '';
    checkArea.innerHTML = '';
    checkArea.style.display = 'none';
    checkBtn.style.display = 'none';
    optionsArea.style.display = 'grid';

    if (q.type === 'TF') {
        optionsArea.innerHTML = 
            '<button class="btn option-btn" onclick="answer(true)">â­• æ­£ç¢º (O)</button>' +
            '<button class="btn option-btn" onclick="answer(false)">âŒ éŒ¯èª¤ (X)</button>';
    } else if (q.type === 'MC') {
        q.options.forEach(function(opt, idx) {
            var btn = document.createElement('button');
            btn.className = 'btn option-btn';
            btn.innerText = (idx+1) + ". " + opt;
            btn.onclick = function() { answer(idx); };
            optionsArea.appendChild(btn);
        });
    } else if (q.type === 'CHECK') {
        optionsArea.style.display = 'none';
        checkArea.style.display = 'grid';
        checkBtn.style.display = 'block';
        q.options.forEach(function(opt, idx) {
            checkArea.innerHTML += 
                '<label class="checkbox-item">' +
                '<input type="checkbox" value="' + idx + '"> ' + opt +
                '</label>';
        });
    }
}

function answer(userAns) {
    var q = gameState.currentQuestions[gameState.currentIndex];
    var isCorrect = false;

    if (q.type === 'TF') {
        isCorrect = (userAns === q.a);
    } else if (q.type === 'MC') {
        isCorrect = (userAns === q.ans);
    }
    processResult(isCorrect, q);
}

function checkCheckboxAnswer() {
    var q = gameState.currentQuestions[gameState.currentIndex];
    var checkboxes = document.querySelectorAll('#checkbox-area input:checked');
    var checked = [];
    for(var i=0; i<checkboxes.length; i++) {
        checked.push(parseInt(checkboxes[i].value));
    }